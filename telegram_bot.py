import os
import logging
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler, ConversationHandler
from transformers import pipeline, AutoTokenizer, AutoModelForSequenceClassification
from models import (
    get_session, Employee, Event, Task, TaskStatus, 
    Activity, activity_participants, EventType, ActivityType, 
    Session, Base, engine, GeneralInfo
)
from sqlalchemy import or_, and_
import re
from typing import List, Dict, Tuple, Optional, Union
import json
import requests
from dotenv import load_dotenv
import torch
import difflib
import nltk
from nltk.tokenize import word_tokenize
from nltk.corpus import stopwords
from nltk.stem import SnowballStemmer
from collections import defaultdict
from functools import lru_cache
from Levenshtein import distance as levenshtein_distance

# Download all required NLTK data
required_nltk_data = ['punkt', 'stopwords', 'punkt_tab']
for item in required_nltk_data:
    try:
        nltk.data.find(f'tokenizers/{item}')
    except LookupError:
        nltk.download(item, quiet=True)

# Load environment variables
load_dotenv()

# Configure logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# States for conversation handler
CHOOSING, TYPING_REPLY = range(2)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
try:
    classifier = pipeline(
        "zero-shot-classification",
        model="facebook/bart-large-mnli",
        device=0 if torch.cuda.is_available() else -1,
        framework="pt",
        top_k=3,  # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-3 –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        batch_size=1,  # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
        max_length=512,  # –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        truncation=True
    )
except Exception as e:
    logger.error(f"Error initializing classifier: {e}")
    # Fallback to a simpler model if the main one fails
    classifier = pipeline(
        "zero-shot-classification",
        model="facebook/bart-large-mnli",
        device=-1,  # Force CPU
        framework="pt",
        top_k=3
    )

# Define categories for classification
categories = [
    "–ø–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞",
    "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏",
    "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ",
    "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏",
    "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ",
    "–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",
    "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å"
]

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–≤—ã–∫–∞–º
classification_hypotheses = {
    "–ø–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞": [
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø–æ–∏—Å–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ –Ω–∞–≤—ã–∫–∞–º–∏ –∏–ª–∏ –∑–Ω–∞–Ω–∏—è–º–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ç–æ–º, –∫—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–µ–π",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø–æ–∏—Å–∫–µ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ç–æ–º, –∫—Ç–æ –∑–Ω–∞–µ—Ç –∏–ª–∏ —É–º–µ–µ—Ç —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø–æ–∏—Å–∫–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ç–æ–º, –∫—Ç–æ –º–æ–∂–µ—Ç –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –æ–ø—ã—Ç–æ–º –∏–ª–∏ –∑–Ω–∞–Ω–∏—è–º–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø–æ–∏—Å–∫–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞"
    ],
    "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏": [
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –∏–ª–∏ —Å–æ–±—ã—Ç–∏–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –∏–ª–∏ –ø–ª–∞–Ω–∞—Ö –∫–æ–º–ø–∞–Ω–∏–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –≤—Å—Ç—Ä–µ—á–∞—Ö –∏–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –¥–∞—Ç–∞—Ö –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –¥–µ—Ç–∞–ª—è—Ö –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π"
    ],
    "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ": [
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ä–∞–±–æ—á–µ–π –∑–∞–¥–∞—á–µ –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–µ",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Å—Ç–∞—Ç—É—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö –∏–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞—Ö –∑–∞–¥–∞—á",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á –º–µ–∂–¥—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Ä–∞–±–æ—Ç—ã"
    ],
    "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏": [
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –≤–Ω–µ—Ä–∞–±–æ—á–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ö–æ–±–±–∏, –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö –∏–ª–∏ —É–≤–ª–µ—á–µ–Ω–∏—è—Ö –∫–æ–ª–ª–µ–≥",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö –∏–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞–Ω—è—Ç–∏—è—Ö –∏–ª–∏ –∏–≥—Ä–∞—Ö",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –¥–æ—Å—É–≥–µ –∏–ª–∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è—Ö –≤ –∫–æ–º–ø–∞–Ω–∏–∏"
    ],
    "–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ": [
        "–≠—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–ª–∏ –Ω–∞—á–∞–ª–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞",
        "–≠—Ç–æ –≤–µ–∂–ª–∏–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –±–æ—Ç—É",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞",
        "–≠—Ç–æ –ø—Ä–æ—â–∞–Ω–∏–µ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞",
        "–≠—Ç–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ –∏–ª–∏ –ø—Ä–∏–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
    ],
    "–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è": [
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –ø–æ–ª–∏—Ç–∏–∫–∞—Ö, –ø—Ä–∞–≤–∏–ª–∞—Ö –∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –∫—É–ª—å—Ç—É—Ä–µ –∏–ª–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—è—Ö",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Ä–µ—Å—É—Ä—Å–∞—Ö –∏–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –∫–æ–º–ø–∞–Ω–∏–∏",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
    ],
    "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å": [
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å, —Ç—Ä–µ–±—É—é—â–∏–π —É—Ç–æ—á–Ω–µ–Ω–∏—è –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
        "–≠—Ç–æ –Ω–µ—è—Å–Ω—ã–π –∏–ª–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–π—Å—è –∫ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–ª–æ–∂–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å",
        "–≠—Ç–æ –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"
    ]
}

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
query_variations = {
    # –û—Ç–¥–µ–ª—ã –∏ –∫–æ–º–∞–Ω–¥—ã
    "it": ["it", "–∞–π—Ç–∏", "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞", "–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç–¥–µ–ª", "—Ç–µ—Ö –æ—Ç–¥–µ–ª"],
    "–æ—Ç–¥–µ–ª": ["–æ—Ç–¥–µ–ª", "–æ—Ç–¥–µ–ª–µ", "–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç", "–∫–æ–º–∞–Ω–¥–∞", "–≥—Ä—É–ø–ø–∞", "–ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ", "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"],
    "hr": ["hr", "—ç–π—á–∞—Ä", "–∫–∞–¥—Ä—ã", "–ø–µ—Ä—Å–æ–Ω–∞–ª", "–æ—Ç–¥–µ–ª –∫–∞–¥—Ä–æ–≤", "hr –æ—Ç–¥–µ–ª", "—ç–π—á–∞—Ä –æ—Ç–¥–µ–ª"],
    "–º–∞—Ä–∫–µ—Ç–∏–Ω–≥": ["–º–∞—Ä–∫–µ—Ç–∏–Ω–≥", "–º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π", "—Ä–µ–∫–ª–∞–º–∞", "–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ", "pr", "–ø–∏–∞—Ä"],
    "–ø—Ä–æ–¥–∞–∂–∏": ["–ø—Ä–æ–¥–∞–∂–∏", "–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π", "sales", "—Å–µ–π–ª–∑", "–æ—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂"],
    
    # –î–µ–π—Å—Ç–≤–∏—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    "—Ä–∞–±–æ—Ç–∞–µ—Ç": ["—Ä–∞–±–æ—Ç–∞–µ—Ç", "—Ä–∞–±–æ—Ç–∞—é—Ç", "—Ç—Ä—É–¥–∏—Ç—Å—è", "—Ç—Ä—É–¥—è—Ç—Å—è", "–Ω–∞—Ö–æ–¥–∏—Ç—Å—è", "–Ω–∞—Ö–æ–¥—è—Ç—Å—è", "—Å–æ—Å—Ç–æ–∏—Ç", "—Å–æ—Å—Ç–æ—è—Ç"],
    "—É—á–∞—Å—Ç–Ω–∏–∫–∏": ["—É—á–∞—Å—Ç–Ω–∏–∫–∏", "—É—á–∞—Å—Ç–Ω–∏–∫", "—á–ª–µ–Ω—ã", "—á–ª–µ–Ω", "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏", "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫", "–∫–æ–ª–ª–µ–≥–∏", "–∫–æ–ª–ª–µ–≥–∞"],
    "–∑–Ω–∞–µ—Ç": ["–∑–Ω–∞–µ—Ç", "—É–º–µ–µ—Ç", "–º–æ–∂–µ—Ç", "—Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è", "–ø–æ–Ω–∏–º–∞–µ—Ç", "–≤–ª–∞–¥–µ–µ—Ç", "–∏–º–µ–µ—Ç –æ–ø—ã—Ç", "–æ–ø—ã—Ç–µ–Ω", "–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–µ–Ω"],
    "–ø–æ–º–æ—á—å": ["–ø–æ–º–æ—á—å", "–ø–æ–¥—Å–∫–∞–∑–∞—Ç—å", "–Ω–∞—É—á–∏—Ç—å", "–æ–±—ä—è—Å–Ω–∏—Ç—å", "–ø–æ–∫–∞–∑–∞—Ç—å", "—Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å", "–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å", "–ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å"],
    
    # –ó–∞–¥–∞—á–∏ –∏ –ø—Ä–æ–µ–∫—Ç—ã
    "–∑–∞–¥–∞—á–∏": ["–∑–∞–¥–∞—á–∏", "–∑–∞–¥–∞—á–∞", "–¥–µ–ª–æ", "–¥–µ–ª–∞", "–ø—Ä–æ–µ–∫—Ç", "–ø—Ä–æ–µ–∫—Ç—ã", "—Ä–∞–±–æ—Ç–∞", "—Ä–∞–±–æ—Ç—ã", "–ø–æ—Ä—É—á–µ–Ω–∏–µ", "–ø–æ—Ä—É—á–µ–Ω–∏—è"],
    "–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è": ["–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è", "–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ", "—Å–æ–±—ã—Ç–∏—è", "—Å–æ–±—ã—Ç–∏–µ", "–≤—Å—Ç—Ä–µ—á–∏", "–≤—Å—Ç—Ä–µ—á–∞", "—Å–æ–±—Ä–∞–Ω–∏–µ", "—Å–æ–±—Ä–∞–Ω–∏—è"],
    "–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏": ["–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏", "–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å", "–∑–∞–Ω—è—Ç–∏—è", "–∑–∞–Ω—è—Ç–∏–µ", "–∏–≥—Ä—ã", "–∏–≥—Ä–∞", "–¥–æ—Å—É–≥", "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è"],
    
    # –ù–∞–≤—ã–∫–∏ –∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏
    "–Ω–∞–≤—ã–∫–∏": ["–Ω–∞–≤—ã–∫–∏", "—É–º–µ–Ω–∏—è", "–∑–Ω–∞–Ω–∏—è", "–æ–ø—ã—Ç", "–∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏", "—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏", "–∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è", "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º"],
    "—ç–∫—Å–ø–µ—Ä—Ç": ["—ç–∫—Å–ø–µ—Ä—Ç", "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª", "–º–∞—Å—Ç–µ—Ä", "–≥—É—Ä—É", "–∑–Ω–∞—Ç–æ–∫", "–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç", "—Ç—Ä–µ–Ω–µ—Ä"],
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
    "—Å–µ–≥–æ–¥–Ω—è": ["—Å–µ–≥–æ–¥–Ω—è", "—Å–µ–π—á–∞—Å", "–≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç", "–Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç"],
    "–∑–∞–≤—Ç—Ä–∞": ["–∑–∞–≤—Ç—Ä–∞", "—Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å", "–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å"],
    "–Ω–µ–¥–µ–ª—è": ["–Ω–µ–¥–µ–ª—è", "–Ω–µ–¥–µ–ª—é", "–Ω–∞ –Ω–µ–¥–µ–ª–µ", "–≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏", "–Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ"],
    "–º–µ—Å—è—Ü": ["–º–µ—Å—è—Ü", "–º–µ—Å—è—Ü", "–≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞", "–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ", "–Ω–∞ –º–µ—Å—è—Ü"],
    
    # –°—Ç–∞—Ç—É—Å—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
    "–≤–∞–∂–Ω–æ": ["–≤–∞–∂–Ω–æ", "—Å—Ä–æ—á–Ω–æ", "–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ", "–∫—Ä–∏—Ç–∏—á–Ω–æ", "–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ", "–Ω—É–∂–Ω–æ"],
    "–≥–æ—Ç–æ–≤–æ": ["–≥–æ—Ç–æ–≤–æ", "–∑–∞–≤–µ—Ä—à–µ–Ω–æ", "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ", "—Å–¥–µ–ª–∞–Ω–æ", "–∑–∞–∫–æ–Ω—á–µ–Ω–æ", "–æ–∫–æ–Ω—á–µ–Ω–æ"],
    "–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ": ["–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ", "–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è", "–¥–µ–ª–∞–µ—Ç—Å—è", "—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥", "–∑–∞–Ω—è—Ç", "–≤ —Ä–∞–±–æ—Ç–µ"],
    
    # –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    "–π–æ–≥–∞": ["–π–æ–≥–∞", "–π–æ–≥–æ–π", "–∑–∞–Ω—è—Ç–∏—è –π–æ–≥–æ–π", "–ø—Ä–∞–∫—Ç–∏–∫–∞ –π–æ–≥–∏"],
    "—Å–ø–æ—Ä—Ç": ["—Å–ø–æ—Ä—Ç", "—Å–ø–æ—Ä—Ç–æ–º", "—Ñ–∏—Ç–Ω–µ—Å", "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏", "–∑–∞–Ω—è—Ç–∏—è —Å–ø–æ—Ä—Ç–æ–º"],
    "–∏–≥—Ä—ã": ["–∏–≥—Ä—ã", "–∏–≥—Ä–∞", "–∏–≥—Ä–æ–≤—ã–µ", "–≥–µ–π–º–∏–Ω–≥", "–∏–≥—Ä–æ–≤—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"],
    "–æ–±—É—á–µ–Ω–∏–µ": ["–æ–±—É—á–µ–Ω–∏–µ", "—Ç—Ä–µ–Ω–∏–Ω–≥", "–∫—É—Ä—Å", "—Å–µ–º–∏–Ω–∞—Ä", "–≤–µ–±–∏–Ω–∞—Ä", "–º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å"]
}

# –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ç–æ—á–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
category_patterns = {
    "–ø–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞": [
        # –ü–æ–∏—Å–∫ –ø–æ –æ—Ç–¥–µ–ª—É
        r"–∫—Ç–æ\s+(?:—Ä–∞–±–æ—Ç–∞–µ—Ç|—Ç—Ä—É–¥–∏—Ç—Å—è|–Ω–∞—Ö–æ–¥–∏—Ç—Å—è)\s+–≤\s+(?:it|–æ—Ç–¥–µ–ª–µ|–∫–æ–º–∞–Ω–¥–µ|–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–µ)",
        r"—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏\s+(?:it|–æ—Ç–¥–µ–ª–∞|–∫–æ–º–∞–Ω–¥—ã|–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞)",
        r"—Å–æ—Å—Ç–∞–≤\s+(?:it|–æ—Ç–¥–µ–ª–∞|–∫–æ–º–∞–Ω–¥—ã|–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞)",
        # –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–≤—ã–∫–∞–º
        r"–∫—Ç–æ\s+(?:–∑–Ω–∞–µ—Ç|—É–º–µ–µ—Ç|–º–æ–∂–µ—Ç|—Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è)\s+–≤\s+(?:python|java|javascript|–¥–∏–∑–∞–π–Ω|–º–∞—Ä–∫–µ—Ç–∏–Ω–≥)",
        r"–Ω–∞–π—Ç–∏\s+(?:—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞|—ç–∫—Å–ø–µ—Ä—Ç–∞)\s+–ø–æ\s+(?:python|java|javascript|–¥–∏–∑–∞–π–Ω|–º–∞—Ä–∫–µ—Ç–∏–Ω–≥)",
        r"–µ—Å—Ç—å\s+–ª–∏\s+(?:–∫—Ç–æ-—Ç–æ|–∫—Ç–æ)\s+(?:–∫—Ç–æ|–∫—Ç–æ-—Ç–æ)\s+(?:–∑–Ω–∞–µ—Ç|—É–º–µ–µ—Ç|–º–æ–∂–µ—Ç)\s+(?:python|java|javascript|–¥–∏–∑–∞–π–Ω|–º–∞—Ä–∫–µ—Ç–∏–Ω–≥)",
        # –ü–æ–∏—Å–∫ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
        r"–∫—Ç–æ\s+(?:–∑–∞–Ω–∏–º–∞–µ—Ç—Å—è|—É–≤–ª–µ–∫–∞–µ—Ç—Å—è|–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è)\s+(?:–π–æ–≥–æ–π|—Å–ø–æ—Ä—Ç–æ–º|–∏–≥—Ä–∞–º–∏|–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º)",
        r"–Ω–∞–π—Ç–∏\s+(?:–∫–æ–ª–ª–µ–≥|—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤)\s+(?:–¥–ª—è|–ø–æ)\s+(?:–π–æ–≥–µ|—Å–ø–æ—Ä—Ç—É|–∏–≥—Ä–∞–º|–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é)",
        # –û–±—â–∏–π –ø–æ–∏—Å–∫
        r"–Ω–∞–π—Ç–∏\s+(?:—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞|—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞|—ç–∫—Å–ø–µ—Ä—Ç–∞)",
        r"–ø–æ–∏—Å–∫\s+(?:—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞|—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞|—ç–∫—Å–ø–µ—Ä—Ç–∞)",
        r"–∫—Ç–æ\s+(?:–º–æ–∂–µ—Ç|–≥–æ—Ç–æ–≤)\s+–ø–æ–º–æ—á—å\s+—Å"
    ],
    "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏": [
        # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
        r"–∫–∞–∫–∏–µ\s+(?:–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è|—Å–æ–±—ã—Ç–∏—è|–≤—Å—Ç—Ä–µ—á–∏)\s+(?:–±—É–¥—É—Ç|–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã)\s+(?:—Å–µ–≥–æ–¥–Ω—è|–∑–∞–≤—Ç—Ä–∞|–Ω–∞ –Ω–µ–¥–µ–ª–µ|–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ)",
        r"–∫–æ–≥–¥–∞\s+(?:–±—É–¥–µ—Ç|–ø—Ä–æ–π–¥–µ—Ç|—Å–æ—Å—Ç–æ–∏—Ç—Å—è)\s+(?:–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ|—Å–æ–±—ã—Ç–∏–µ|–≤—Å—Ç—Ä–µ—á–∞)",
        # –¢–∏–ø—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
        r"(?:—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ|–∫–∞–ª–µ–Ω–¥–∞—Ä—å)\s+(?:–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π|—Å–æ–±—ã—Ç–∏–π|–≤—Å—Ç—Ä–µ—á)",
        r"—á—Ç–æ\s+(?:–±—É–¥–µ—Ç|–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ)\s+(?:—Å–µ–≥–æ–¥–Ω—è|–∑–∞–≤—Ç—Ä–∞|–Ω–∞ –Ω–µ–¥–µ–ª–µ)",
        r"–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è\s+–æ\s+(?:–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏|—Å–æ–±—ã—Ç–∏–∏|–≤—Å—Ç—Ä–µ—á–µ)"
    ],
    "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ": [
        # –°—Ç–∞—Ç—É—Å—ã –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
        r"–∫–∞–∫–∏–µ\s+(?:–∑–∞–¥–∞—á–∏|–ø—Ä–æ–µ–∫—Ç—ã|—Ä–∞–±–æ—Ç—ã)\s+(?:–µ—Å—Ç—å|–Ω–∞–∑–Ω–∞—á–µ–Ω—ã|–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)",
        r"—Å—Ç–∞—Ç—É—Å\s+(?:–∑–∞–¥–∞—á–∏|–ø—Ä–æ–µ–∫—Ç–∞|—Ä–∞–±–æ—Ç—ã)",
        r"–∫–æ–≥–¥–∞\s+(?:–Ω—É–∂–Ω–æ|—Å–ª–µ–¥—É–µ—Ç)\s+(?:–∑–∞–∫–æ–Ω—á–∏—Ç—å|–∑–∞–≤–µ—Ä—à–∏—Ç—å|—Å–¥–∞—Ç—å)",
        # –î–µ–¥–ª–∞–π–Ω—ã
        r"–¥–µ–¥–ª–∞–π–Ω\s+(?:–¥–ª—è|–ø–æ)\s+(?:–∑–∞–¥–∞—á–µ|–ø—Ä–æ–µ–∫—Ç—É|—Ä–∞–±–æ—Ç–µ)",
        r"—Å—Ä–æ–∫–∏\s+(?:–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è|—Å–¥–∞—á–∏)\s+(?:–∑–∞–¥–∞—á–∏|–ø—Ä–æ–µ–∫—Ç–∞|—Ä–∞–±–æ—Ç—ã)",
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
        r"–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç\s+(?:–∑–∞–¥–∞—á–∏|–ø—Ä–æ–µ–∫—Ç–∞|—Ä–∞–±–æ—Ç—ã)",
        r"–≤–∞–∂–Ω–æ—Å—Ç—å\s+(?:–∑–∞–¥–∞—á–∏|–ø—Ä–æ–µ–∫—Ç–∞|—Ä–∞–±–æ—Ç—ã)"
    ],
    "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏": [
        # –¢–∏–ø—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
        r"–∫–∞–∫–∏–µ\s+(?:–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏|–∑–∞–Ω—è—Ç–∏—è|–∏–≥—Ä—ã)\s+(?:–±—É–¥—É—Ç|–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã)",
        r"–∫—Ç–æ\s+(?:–∑–∞–Ω–∏–º–∞–µ—Ç—Å—è|—É–≤–ª–µ–∫–∞–µ—Ç—Å—è|–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è)\s+(?:–π–æ–≥–æ–π|—Å–ø–æ—Ä—Ç–æ–º|–∏–≥—Ä–∞–º–∏)",
        # –£—á–∞—Å—Ç–∏–µ
        r"–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è\s+–∫\s+(?:–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏|–∑–∞–Ω—è—Ç–∏—é|–∏–≥—Ä–µ)",
        r"—É—á–∞—Å—Ç–∏–µ\s+–≤\s+(?:–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏|–∑–∞–Ω—è—Ç–∏–∏|–∏–≥—Ä–µ)",
        # –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
        r"–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å\s+(?:–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å|–∑–∞–Ω—è—Ç–∏–µ|–∏–≥—Ä—É)",
        r"—Å–æ–∑–¥–∞—Ç—å\s+(?:–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å|–∑–∞–Ω—è—Ç–∏–µ|–∏–≥—Ä—É)"
    ]
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–µ–º–º–µ—Ä–∞ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
stemmer = SnowballStemmer("russian")

def analyze_query(query: str) -> dict:
    """Analyze query to extract entities and intent with improved accuracy."""
    try:
        logger.info(f"Analyzing query: {query}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query = query.lower().strip()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        result = {
            'entities': {
                'skills': [],
                'departments': [],
                'event_types': [],
                'task_types': [],
                'activities': [],
                'priorities': [],
                'statuses': [],
                'dates': [],
                'topics': [],
                'categories': [],
                'assignees': [],
                'organizers': []
            },
            'intent': None,
            'confidence': 0.0
        }
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        time_patterns = {
            'today': ['—Å–µ–≥–æ–¥–Ω—è', '—Å–µ–π—á–∞—Å', '–≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç', '–Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç'],
            'tomorrow': ['–∑–∞–≤—Ç—Ä–∞', '–Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å', '–ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞'],
            'this_week': ['–Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ', '–≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏', '–¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏', '–Ω–∞ –Ω–µ–¥–µ–ª–µ'],
            'next_week': ['–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ', '–≤ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é'],
            'this_month': ['–≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ', '–¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞', '–≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞'],
            'next_month': ['–≤ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ', '–≤ –±—É–¥—É—â–µ–º –º–µ—Å—è—Ü–µ']
        }
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π
        intent_patterns = {
            'search_employee': [
                '–∫—Ç–æ', '–Ω–∞–π—Ç–∏', '–ø–æ–∏—Å–∫', '–ø–æ–∫–∞–∂–∏', '–µ—Å—Ç—å –ª–∏', '–º–æ–∂–µ—Ç –ª–∏',
                '–∫—Ç–æ-–Ω–∏–±—É–¥—å', '–∫—Ç–æ-—Ç–æ', '–∫—Ç–æ –∏–∑', '–∫—Ç–æ –≤', '–∫—Ç–æ –Ω–∞',
                '–∑–Ω–∞–µ—Ç', '—É–º–µ–µ—Ç', '–º–æ–∂–µ—Ç', '—Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è', '—Ä–∞–±–æ—Ç–∞–µ—Ç',
                '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '—ç–∫—Å–ø–µ—Ä—Ç', '—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', '–∏–Ω–∂–µ–Ω–µ—Ä'
            ],
            'search_event': [
                '–∫–æ–≥–¥–∞', '–≥–¥–µ', '–≤–æ —Å–∫–æ–ª—å–∫–æ', '–≤—Ä–µ–º—è', '–¥–∞—Ç–∞',
                '–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', '–≤—Å—Ç—Ä–µ—á–∞', '—Å–æ–±—ã—Ç–∏–µ', '—Ç—Ä–µ–Ω–∏–Ω–≥',
                '—Å–æ–±—Ä–∞–Ω–∏–µ', '–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è', '–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',
                '–±—É–¥–µ—Ç', '–ø—Ä–æ–π–¥–µ—Ç', '—Å–æ—Å—Ç–æ–∏—Ç—Å—è', '–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ'
            ],
            'search_task': [
                '–∑–∞–¥–∞—á–∞', 'todo', '—á—Ç–æ –Ω—É–∂–Ω–æ', '—á—Ç–æ —Å–¥–µ–ª–∞—Ç—å',
                '—á—Ç–æ –¥–µ–ª–∞—Ç—å', '—á—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å', '—á—Ç–æ –≤ —Ä–∞–±–æ—Ç–µ',
                '—Å—Ç–∞—Ç—É—Å', '–ø—Ä–æ–≥—Ä–µ—Å—Å', '–¥–µ–¥–ª–∞–π–Ω', '—Å—Ä–æ–∫',
                '–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–≤–∞–∂–Ω–æ—Å—Ç—å', '—Å—Ä–æ—á–Ω–æ—Å—Ç—å'
            ],
            'search_activity': [
                '–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ', '—á–µ–º –∑–∞–Ω—è—Ç—å—Å—è',
                '–∫—É–¥–∞ –ø–æ–π—Ç–∏', '—á—Ç–æ –¥–µ–ª–∞—Ç—å', '–¥–æ—Å—É–≥',
                '–∏–≥—Ä–∞', '—Å–ø–æ—Ä—Ç', '–π–æ–≥–∞', '—Ç–∏–º–±–∏–ª–¥–∏–Ω–≥'
            ],
            'search_info': [
                '–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–∫–∞–∫', '–≥–¥–µ', '—á—Ç–æ', '–∫–æ–≥–¥–∞',
                '–ø–æ—á–µ–º—É', '–∑–∞—á–µ–º', '–∫–∞–∫–æ–π', '–∫–∞–∫–∞—è', '–∫–∞–∫–∏–µ',
                '—Ä–∞—Å—Å–∫–∞–∂–∏', '–ø–æ–¥—Å–∫–∞–∂–∏', '–æ–±—ä—è—Å–Ω–∏'
            ]
        }
        
        # –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
        for time_key, patterns in time_patterns.items():
            if any(pattern in query for pattern in patterns):
                result['entities']['dates'].append(time_key)
        
        # –ê–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏–π
        for intent, patterns in intent_patterns.items():
            if any(pattern in query for pattern in patterns):
                result['intent'] = intent
                break
        
        # –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context_words = {
            'skills': ['–∑–Ω–∞–µ—Ç', '—É–º–µ–µ—Ç', '–º–æ–∂–µ—Ç', '—Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è', '–æ–ø—ã—Ç', '–Ω–∞–≤—ã–∫–∏'],
            'departments': ['–æ—Ç–¥–µ–ª', '–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç', '–∫–æ–º–∞–Ω–¥–∞', '–≥—Ä—É–ø–ø–∞'],
            'event_types': ['–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', '–≤—Å—Ç—Ä–µ—á–∞', '—Å–æ–±—ã—Ç–∏–µ', '—Ç—Ä–µ–Ω–∏–Ω–≥'],
            'task_types': ['–∑–∞–¥–∞—á–∞', '–ø—Ä–æ–µ–∫—Ç', '—Ä–∞–±–æ—Ç–∞', '–ø–æ—Ä—É—á–µ–Ω–∏–µ'],
            'activities': ['–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ', '–¥–æ—Å—É–≥', '–∏–≥—Ä–∞']
        }
        
        for entity_type, words in context_words.items():
            if any(word in query for word in words):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ—Å–ª–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö —Å–ª–æ–≤
                words = query.split()
                for i, word in enumerate(words):
                    if word in context_words[entity_type] and i + 1 < len(words):
                        result['entities'][entity_type].append(words[i + 1])
        
        # –†–∞—Å—á–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        confidence = 0.0
        total_entities = sum(len(entities) for entities in result['entities'].values())
        if total_entities > 0:
            confidence += 0.4
        if result['intent']:
            confidence += 0.3
        if len(query.split()) > 2:
            confidence += 0.3
        
        result['confidence'] = min(confidence, 1.0)
        
        return result
        
    except Exception as e:
        logger.error(f"Error analyzing query: {e}")
        return {
            'entities': {
                'skills': [],
                'departments': [],
                'event_types': [],
                'task_types': [],
                'activities': [],
                'priorities': [],
                'statuses': [],
                'dates': [],
                'topics': [],
                'categories': [],
                'assignees': [],
                'organizers': []
            },
            'intent': None,
            'confidence': 0.0
        }

def preprocess_query(query: str) -> str:
    """Preprocess query with improved normalization and cleaning."""
    try:
        logger.info(f"Preprocessing query: {query}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞
        query = query.lower()
        
        # –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
        query = ' '.join(query.split())
        
        # –£–¥–∞–ª–µ–Ω–∏–µ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏
        query = ''.join(char for char in query if char.isalnum() or char.isspace())
        
        # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–æ–ø-—Å–ª–æ–≤
        stop_words = set(stopwords.words('russian'))
        query_tokens = query.split()
        query_tokens = [token for token in query_tokens if token not in stop_words]
        
        # –°—Ç–µ–º–º–∏–Ω–≥
        stemmer = SnowballStemmer('russian')
        query_tokens = [stemmer.stem(token) for token in query_tokens]
        
        # –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç—Ä–æ–∫—É
        processed_query = ' '.join(query_tokens)
        
        logger.info(f"Processed query: {processed_query}")
        return processed_query
        
    except Exception as e:
        logger.error(f"Error preprocessing query: {e}")
        return query.lower().strip()

def classify_query(query: str) -> Tuple[str, float]:
    """
    –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –∞–Ω–∞–ª–∏–∑–∞.
    """
    try:
        # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        processed_query = preprocess_query(query)
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        analysis = analyze_query(query)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
        if analysis['intent'] == 'search_event' or any(word in query.lower() for word in ['–∫–æ–≥–¥–∞', '–≥–¥–µ', '–≤–æ —Å–∫–æ–ª—å–∫–æ', '–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ', '–≤—Å—Ç—Ä–µ—á–∞', '—Å–æ–±—ã—Ç–∏–µ']):
            category = "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏"
            confidence = 0.9
        elif analysis['intent'] == 'search_task' or any(word in query.lower() for word in ['–∑–∞–¥–∞—á–∞', 'todo', '—á—Ç–æ –Ω—É–∂–Ω–æ', '—á—Ç–æ —Å–¥–µ–ª–∞—Ç—å']):
            category = "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ"
            confidence = 0.9
        elif analysis['intent'] == 'search_employee' or any(word in query.lower() for word in ['–∫—Ç–æ', '–Ω–∞–π—Ç–∏', '–ø–æ–∫–∞–∂–∏', '–µ—Å—Ç—å –ª–∏']):
            category = "–ø–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
            confidence = 0.9
        elif analysis['intent'] == 'search_activity' or any(word in query.lower() for word in ['–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', '—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–µ', '—á–µ–º –∑–∞–Ω—è—Ç—å—Å—è']):
            category = "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
            confidence = 0.9
        elif analysis['intent'] == 'search_info' or any(word in query.lower() for word in ['–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è', '–∫–∞–∫', '–≥–¥–µ', '—á—Ç–æ', '–∫–æ–≥–¥–∞']):
            category = "–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"
            confidence = 0.9
        else:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º ML-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            classification = classifier(
                processed_query,
                categories,
                hypothesis_template="–≠—Ç–æ –∑–∞–ø—Ä–æ—Å –æ {}"
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            best_label = classification['labels'][0]
            best_score = classification['scores'][0]
            
            # –ü–æ–≤—ã—à–∞–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
            confidence = min(1.0, best_score * analysis['confidence'])
            category = best_label
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        if confidence < 0.4:  # –ü–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            return "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å", 1.0
        
        return category, confidence
        
    except Exception as e:
        logger.error(f"Error in classify_query: {e}")
        return "–Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å", 1.0

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Send a message when the command /start is issued."""
    keyboard = [
        [KeyboardButton("üîç –ü–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"), KeyboardButton("üìÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è")],
        [KeyboardButton("üìã –ó–∞–¥–∞—á–∏"), KeyboardButton("üéÆ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")],
        [KeyboardButton("‚ùì –ü–æ–º–æ—â—å"), KeyboardButton("üë• –ú–æ—è –∫–æ–º–∞–Ω–¥–∞")]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    welcome_text = (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –±–æ—Ç!\n\n"
        "–Ø –ø–æ–º–æ–≥—É –≤–∞–º:\n"
        "‚Ä¢ –ù–∞–π—Ç–∏ –∫–æ–ª–ª–µ–≥ –ø–æ –∏–º–µ–Ω–∏, –æ—Ç–¥–µ–ª—É –∏–ª–∏ –Ω–∞–≤—ã–∫–∞–º\n"
        "‚Ä¢ –£–∑–Ω–∞—Ç—å –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö\n"
        "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∞–º–∏\n"
        "‚Ä¢ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é!\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:\n"
        "‚Ä¢ –ö—Ç–æ –∑–Ω–∞–µ—Ç Python?\n"
        "‚Ä¢ –ö–∞–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?\n"
        "‚Ä¢ –ü–æ–∫–∞–∂–∏ –º–æ–∏ –∑–∞–¥–∞—á–∏\n"
        "‚Ä¢ –ö–∞–∫–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è?"
    )
    
    await update.message.reply_text(welcome_text, reply_markup=reply_markup)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Send a message when the command /help is issued."""
    help_text = (
        "ü§ñ *–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:*\n\n"
        "*–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞—Ö:*\n"
        "‚Ä¢ '–ö—Ç–æ –∑–Ω–∞–µ—Ç Python?'\n"
        "‚Ä¢ '–ù–∞–π–¥–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ IT –æ—Ç–¥–µ–ª–∞'\n"
        "‚Ä¢ '–ü–æ–∫–∞–∂–∏ –≤—Å–µ—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤'\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —É –ú–∞—Ä–∏–∏ –ò–≤–∞–Ω–æ–≤–æ–π?'\n"
        "‚Ä¢ '–ö—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –π–æ–≥–æ–π?'\n\n"
        "*–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö:*\n"
        "‚Ä¢ '–ö–∞–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?'\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ —Ç—Ä–µ–Ω–∏–Ω–≥ –ø–æ Python?'\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ —Å–ª–µ–¥—É—é—â–∞—è –≤—Å—Ç—Ä–µ—á–∞ –∫–æ–º–∞–Ω–¥—ã?'\n"
        "‚Ä¢ '–ß—Ç–æ –±—É–¥–µ—Ç –∑–∞–≤—Ç—Ä–∞?'\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–±–µ–¥?'\n"
        "*–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –æ –∑–∞–¥–∞—á–∞—Ö:*\n"
        "‚Ä¢ '–ö–∞–∫–∏–µ —É –º–µ–Ω—è –∑–∞–¥–∞—á–∏?'\n"
        "‚Ä¢ '–ü–æ–∫–∞–∂–∏ –º–æ–∏ –∑–∞–¥–∞—á–∏ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ'\n"
        "‚Ä¢ '–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç–µ?'\n"
        "‚Ä¢ '–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º?'\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ –¥–µ–¥–ª–∞–π–Ω –ø–æ –ø—Ä–æ–µ–∫—Ç—É?'\n\n"
        "*–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö:*\n"
        "‚Ä¢ '–ö–∞–∫–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è?'\n"
        "‚Ä¢ '–ö—Ç–æ –∏–≥—Ä–∞–µ—Ç –≤ –Ω–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã?'\n"
        "‚Ä¢ '–ö–æ–≥–¥–∞ —Å–ª–µ–¥—É—é—â–µ–µ –∑–∞–Ω—è—Ç–∏–µ –π–æ–≥–æ–π?'\n"
        "‚Ä¢ '–ö–∞–∫–∏–µ —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏?'\n"
        "‚Ä¢ '–ö–∞–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Ç–∏–º–±–∏–ª–¥–∏–Ω–≥—É?'\n\n"
        "*–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã:*\n"
        "‚Ä¢ '–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ—Ñ–∏—Å?'\n"
        "‚Ä¢ '–ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å IT –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π?'\n"
        "‚Ä¢ '–ö–∞–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –∫–æ–º–ø–∞–Ω–∏–∏?'\n"
        "‚Ä¢ '–ì–¥–µ –Ω–∞–π—Ç–∏ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π?'\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º!"
    )
    await update.message.reply_text(help_text, parse_mode='Markdown')

def smart_fuzzy_search(items: list, query: str, fields: list) -> list:
    """Perform smart fuzzy search with improved accuracy and relevance."""
    try:
        logger.info(f"Performing fuzzy search for query: {query}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query = query.lower().strip()
        query_tokens = query.split()
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        results = []
        scores = {}
        
        # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        for item in items:
            item_score = 0.0
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ
            for field in fields:
                if hasattr(item, field):
                    field_value = str(getattr(item, field)).lower()
                    field_tokens = field_value.split()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    if query in field_value:
                        item_score += 1.0
                        continue
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                    for token in query_tokens:
                        if token in field_value:
                            item_score += 0.5
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ö–æ–∂–µ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤
                        for field_token in field_tokens:
                            similarity = calculate_similarity(token, field_token)
                            if similarity > 0.8:
                                item_score += similarity * 0.3
            
            # –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            if item_score > 0:
                scores[item] = item_score
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        sorted_items = sorted(scores.items(), key=lambda x: x[1], reverse=True)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        return [item for item, score in sorted_items[:5]]
        
    except Exception as e:
        logger.error(f"Error in fuzzy search: {e}")
        return []

def calculate_similarity(str1: str, str2: str) -> float:
    """Calculate similarity between two strings using Levenshtein distance."""
    try:
        # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã
        if str1 == str2:
            return 1.0
        
        # –ï—Å–ª–∏ –æ–¥–Ω–∞ –∏–∑ —Å—Ç—Ä–æ–∫ –ø—É—Å—Ç–∞—è
        if not str1 or not str2:
            return 0.0
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞
        distance = levenshtein_distance(str1, str2)
        
        # –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É
        max_len = max(len(str1), len(str2))
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ö–æ–∂–µ—Å—Ç—å
        similarity = 1.0 - (distance / max_len)
        
        return similarity
        
    except Exception as e:
        logger.error(f"Error calculating similarity: {e}")
        return 0.0

def levenshtein_distance(str1: str, str2: str) -> int:
    """Calculate Levenshtein distance between two strings."""
    try:
        # –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É
        matrix = [[0 for _ in range(len(str2) + 1)] for _ in range(len(str1) + 1)]
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –∏ —Å—Ç–æ–ª–±–µ—Ü
        for i in range(len(str1) + 1):
            matrix[i][0] = i
        for j in range(len(str2) + 1):
            matrix[0][j] = j
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Ç—Ä–∏—Ü—É
        for i in range(1, len(str1) + 1):
            for j in range(1, len(str2) + 1):
                if str1[i - 1] == str2[j - 1]:
                    matrix[i][j] = matrix[i - 1][j - 1]
                else:
                    matrix[i][j] = min(
                        matrix[i - 1][j] + 1,  # —É–¥–∞–ª–µ–Ω–∏–µ
                        matrix[i][j - 1] + 1,  # –≤—Å—Ç–∞–≤–∫–∞
                        matrix[i - 1][j - 1] + 1  # –∑–∞–º–µ–Ω–∞
                    )
        
        return matrix[len(str1)][len(str2)]
        
    except Exception as e:
        logger.error(f"Error calculating Levenshtein distance: {e}")
        return max(len(str1), len(str2))

def search_employees(query: str) -> str:
    """Search for employees based on query with improved accuracy."""
    try:
        logger.info(f"Searching employees with query: {query}")
        session = get_session()
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query = query.lower().strip()
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        analysis = analyze_query(query)
        
        # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        base_query = session.query(Employee)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        keywords = []
        if "django" in query:
            keywords.append("django")
        if "python" in query:
            keywords.append("python")
        if "flask" in query:
            keywords.append("flask")
        if "fastapi" in query:
            keywords.append("fastapi")
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        if keywords:
            skill_conditions = []
            for keyword in keywords:
                skill_conditions.append(Employee.skills.ilike(f"%{keyword}%"))
            base_query = base_query.filter(or_(*skill_conditions))
        elif analysis['entities']['skills']:
            skill_conditions = []
            for skill in analysis['entities']['skills']:
                skill_conditions.append(Employee.skills.ilike(f"%{skill}%"))
            base_query = base_query.filter(or_(*skill_conditions))
        
        if analysis['entities']['departments']:
            dept_conditions = []
            for dept in analysis['entities']['departments']:
                dept_conditions.extend([
                    Employee.department.ilike(f"%{dept}%"),
                    Employee.position.ilike(f"%{dept}%")
                ])
            base_query = base_query.filter(or_(*dept_conditions))
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        employees = base_query.all()
        
        if not employees:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
            all_employees = session.query(Employee).all()
            fuzzy_results = smart_fuzzy_search(
                all_employees,
                query,
                ["name", "surname", "position", "department", "skills", "interests"]
            )
            
            if fuzzy_results:
                response = "–¢–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–∫–∞–ª–∏:\n\n"
                for emp in fuzzy_results:
                    response += format_employee_info(emp)
                return response
            
            return "–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞."
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        response = "–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:\n\n"
        for emp in employees:
            response += format_employee_info(emp)
        
        return response
        
    except Exception as e:
        logger.error(f"Error searching employees: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    finally:
        if 'session' in locals():
            session.close()

def format_employee_info(emp: Employee) -> str:
    """Format employee information in a user-friendly way."""
    interests_str = f"üéØ –ò–Ω—Ç–µ—Ä–µ—Å—ã: {emp.interests}\n" if emp.interests else ""
    return (
        f"üë§ *{emp.name} {emp.surname}*\n"
        f"üíº –î–æ–ª–∂–Ω–æ—Å—Ç—å: {emp.position}\n"
        f"üè¢ –û—Ç–¥–µ–ª: {emp.department}\n"
        f"üõ† –ù–∞–≤—ã–∫–∏: {emp.skills}\n"
        f"{interests_str}\n"
    )

def search_events(query: str, session) -> str:
    """Search for events with improved accuracy and relevance."""
    try:
        logger.info(f"Searching events with query: {query}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query = query.lower().strip()
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        analysis = analyze_query(query)
        
        # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        base_query = session.query(Event)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
        if analysis['entities']['event_types']:
            event_conditions = []
            for event_type in analysis['entities']['event_types']:
                event_conditions.extend([
                    Event.title.ilike(f"%{event_type}%"),
                    Event.description.ilike(f"%{event_type}%")
                ])
            base_query = base_query.filter(or_(*event_conditions))
        
        # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        if "—Ç—Ä–µ–Ω–∏–Ω–≥" in query or "python" in query:
            base_query = base_query.filter(
                or_(
                    Event.title.ilike("%—Ç—Ä–µ–Ω–∏–Ω–≥%"),
                    Event.title.ilike("%python%"),
                    Event.description.ilike("%—Ç—Ä–µ–Ω–∏–Ω–≥%"),
                    Event.description.ilike("%python%")
                )
            )
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        events = base_query.all()
        
        if not events:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
            all_events = session.query(Event).all()
            fuzzy_results = smart_fuzzy_search(
                all_events,
                query,
                ["title", "description", "location"]
            )
            
            if fuzzy_results:
                response = "–¢–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–∫–∞–ª–∏:\n\n"
                for event in fuzzy_results:
                    response += format_event_info(event)
                return response
            
            return "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞."
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        response = "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:\n\n"
        for event in events:
            response += format_event_info(event)
        
        return response
        
    except Exception as e:
        logger.error(f"Error searching events: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

def format_event_info(event: Event) -> str:
    """Format event information in a user-friendly way."""
    try:
        return (
            f"üéØ *{event.title}*\n"
            f"üìÖ –î–∞—Ç–∞: {event.date}\n"
            f"‚è∞ –í—Ä–µ–º—è: {event.time}\n"
            f"üìç –ú–µ—Å—Ç–æ: {event.location}\n"
            f"üìù {event.description}\n"
            f"üîπ –¢–∏–ø: {event.type.value}\n\n"
        )
    except Exception as e:
        logger.error(f"Error formatting event info: {e}")
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏: {str(e)}"

def search_tasks(session, query: str) -> str:
    """Search for tasks with improved accuracy and relevance."""
    try:
        logger.info(f"Searching tasks with query: {query}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query = query.lower().strip()
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        analysis = analyze_query(query)
        
        # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        base_query = session.query(Task)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
        if analysis['entities']['priorities']:
            priority_conditions = []
            for priority in analysis['entities']['priorities']:
                priority_conditions.append(Task.priority.ilike(f"%{priority}%"))
            base_query = base_query.filter(or_(*priority_conditions))
        
        if analysis['entities']['statuses']:
            status_conditions = []
            for status in analysis['entities']['statuses']:
                status_conditions.append(Task.status.ilike(f"%{status}%"))
            base_query = base_query.filter(or_(*status_conditions))
        
        if analysis['entities']['dates']:
            date_conditions = []
            for date in analysis['entities']['dates']:
                date_conditions.append(Task.deadline.ilike(f"%{date}%"))
            base_query = base_query.filter(or_(*date_conditions))
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        tasks = base_query.all()
        
        if not tasks:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
            all_tasks = session.query(Task).all()
            fuzzy_results = smart_fuzzy_search(
                all_tasks,
                query,
                ["title", "description", "priority", "status"]
            )
            
            if fuzzy_results:
                response = "–¢–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–∫–∞–ª–∏:\n\n"
                for task in fuzzy_results:
                    response += format_task_info(task)
                return response
            
            return "–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞."
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        response = "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:\n\n"
        for task in tasks:
            response += format_task_info(task)
        
        return response
        
    except Exception as e:
        logger.error(f"Error searching tasks: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∑–∞–¥–∞—á. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

def format_task_info(task: Task) -> str:
    """Format task information in a user-friendly way."""
    return (
        f"üìã *{task.title}*\n"
        f"üìù {task.description}\n"
        f"üìä –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {task.priority}\n"
        f"üìà –°—Ç–∞—Ç—É—Å: {task.status.value}\n"
        f"‚è∞ –°—Ä–æ–∫: {task.deadline}\n"
        f"üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {task.assignee.name if task.assignee else '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}\n\n"
    )

def search_activities(session, query: str) -> str:
    """Search for activities with improved accuracy and relevance."""
    try:
        logger.info(f"Searching activities with query: {query}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query = query.lower().strip()
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        analysis = analyze_query(query)
        
        # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        base_query = session.query(Activity)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
        if analysis['entities']['activities']:
            activity_conditions = []
            for activity in analysis['entities']['activities']:
                activity_conditions.extend([
                    Activity.title.ilike(f"%{activity}%"),
                    Activity.description.ilike(f"%{activity}%")
                ])
            base_query = base_query.filter(or_(*activity_conditions))
        
        if analysis['entities']['dates']:
            date_conditions = []
            for date in analysis['entities']['dates']:
                date_conditions.extend([
                    Activity.start_date.ilike(f"%{date}%"),
                    Activity.end_date.ilike(f"%{date}%")
                ])
            base_query = base_query.filter(or_(*date_conditions))
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        activities = base_query.all()
        
        if not activities:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
            all_activities = session.query(Activity).all()
            fuzzy_results = smart_fuzzy_search(
                all_activities,
                query,
                ["title", "description", "location", "organizer"]
            )
            
            if fuzzy_results:
                response = "–¢–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–∫–∞–ª–∏:\n\n"
                for activity in fuzzy_results:
                    response += format_activity_info(activity)
                return response
            
            return "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞."
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        response = "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:\n\n"
        for activity in activities:
            response += format_activity_info(activity)
        
        return response
        
    except Exception as e:
        logger.error(f"Error searching activities: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

def format_activity_info(activity: Activity) -> str:
    """Format activity information in a user-friendly way."""
    end_date_str = f" - {activity.end_date}" if activity.end_date else ""
    return (
        f"üéØ *{activity.title}*\n"
        f"üìÖ –î–∞—Ç–∞: {activity.start_date}{end_date_str}\n"
        f"üìç –ú–µ—Å—Ç–æ: {activity.location}\n"
        f"üë• –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä: {activity.organizer}\n"
        f"üìù {activity.description}\n"
        f"üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: {activity.participants}\n\n"
    )

def search_general_info(session, query: str) -> str:
    """Search for general information with improved accuracy and relevance."""
    try:
        logger.info(f"Searching general info with query: {query}")
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query = query.lower().strip()
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–∞
        analysis = analyze_query(query)
        
        # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        base_query = session.query(GeneralInfo)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
        if analysis['entities']['topics']:
            topic_conditions = []
            for topic in analysis['entities']['topics']:
                topic_conditions.extend([
                    GeneralInfo.title.ilike(f"%{topic}%"),
                    GeneralInfo.content.ilike(f"%{topic}%")
                ])
            base_query = base_query.filter(or_(*topic_conditions))
        
        if analysis['entities']['categories']:
            category_conditions = []
            for category in analysis['entities']['categories']:
                category_conditions.append(GeneralInfo.category.ilike(f"%{category}%"))
            base_query = base_query.filter(or_(*category_conditions))
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        info_items = base_query.all()
        
        if not info_items:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—á–µ—Ç–∫–∏–π –ø–æ–∏—Å–∫
            all_info = session.query(GeneralInfo).all()
            fuzzy_results = smart_fuzzy_search(
                all_info,
                query,
                ["title", "content", "category"]
            )
            
            if fuzzy_results:
                response = "–¢–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–∫–∞–ª–∏:\n\n"
                for info in fuzzy_results:
                    response += format_general_info(info)
                return response
            
            return "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞."
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        response = "–ù–∞–π–¥–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n\n"
        for info in info_items:
            response += format_general_info(info)
        
        return response
        
    except Exception as e:
        logger.error(f"Error searching general info: {e}")
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."

def format_general_info(info: GeneralInfo) -> str:
    """Format general information in a user-friendly way."""
    return (
        f"üìö *{info.title}*\n"
        f"üìù {info.content}\n"
        f"üè∑ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {info.category}\n"
        f"üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {info.updated_at}\n\n"
    )

def format_employee_results(results):
    if not results:
        return "üòï –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."
    
    response = "üë• *–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:*\n\n"
    for emp in results:
        response += (
            f"*{emp['name']}*\n"
            f"–î–æ–ª–∂–Ω–æ—Å—Ç—å: {emp['position']}\n"
            f"–û—Ç–¥–µ–ª: {emp['department']}\n"
            f"–ù–∞–≤—ã–∫–∏: {emp['skills']}\n"
            f"–ò–Ω—Ç–µ—Ä–µ—Å—ã: {emp['interests']}\n\n"
        )
    return response

def format_event_results(results):
    if not results:
        return "üòï –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."
    
    response = "üìÖ *–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:*\n\n"
    for event in results:
        response += (
            f"*{event['name']}*\n"
            f"–¢–∏–ø: {event['type']}\n"
            f"–î–∞—Ç–∞: {event['date']}\n"
            f"–í—Ä–µ–º—è: {event['time']}\n"
            f"–ú–µ—Å—Ç–æ: {event['location']}\n"
            f"{event['description']}\n\n"
        )
    return response

def format_task_results(results):
    if not results:
        return "üòï –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–¥–∞—á–∏ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."
    
    response = "üìã *–ó–∞–¥–∞—á–∏:*\n\n"
    for task in results:
        response += (
            f"*{task['title']}*\n"
            f"–°—Ç–∞—Ç—É—Å: {task['status']}\n"
            f"–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {task['priority']}\n"
            f"–î–µ–¥–ª–∞–π–Ω: {task['deadline'] or '–ù–µ —É–∫–∞–∑–∞–Ω'}\n"
            f"{task['description']}\n\n"
        )
    return response

def format_activity_results(results):
    if not results:
        return "üòï –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."
    
    response = "üéÆ *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:*\n\n"
    for activity in results:
        response += (
            f"*{activity['name']}*\n"
            f"–¢–∏–ø: {activity['type']}\n"
            f"–î–∞—Ç–∞: {activity['date']}\n"
            f"–í—Ä–µ–º—è: {activity['time']}\n"
            f"–ú–µ—Å—Ç–æ: {activity['location']}\n"
            f"–ú–∞–∫—Å. —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {activity['max_participants']}\n"
            f"{activity['description']}\n\n"
        )
    return response

def format_general_results(results):
    response = ""
    if results['employees']:
        response += "üë• *–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏:*\n" + format_employee_results(results['employees']) + "\n"
    if results['events']:
        response += "üìÖ *–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:*\n" + format_event_results(results['events']) + "\n"
    if results['tasks']:
        response += "üìã *–ó–∞–¥–∞—á–∏:*\n" + format_task_results(results['tasks']) + "\n"
    if results['activities']:
        response += "üéÆ *–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:*\n" + format_activity_results(results['activities']) + "\n"
    
    return response if response else "üòï –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É."

def split_compound_query(query: str) -> List[str]:
    """Split compound query into separate parts."""
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–∞–ø—Ä–æ—Å
    query = query.lower().strip()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
    separators = ["–∏", "–∞ —Ç–∞–∫–∂–µ", "—Ç–∞–∫–∂–µ", "–µ—â–µ", "–∫—Ä–æ–º–µ —Ç–æ–≥–æ", "–ø–ª—é—Å"]
    
    # –ò—â–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –≤ –∑–∞–ø—Ä–æ—Å–µ
    for separator in separators:
        if separator in query:
            # –†–∞–∑–±–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —á–∞—Å—Ç–∏
            parts = query.split(separator)
            # –û—á–∏—â–∞–µ–º —á–∞—Å—Ç–∏ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
            return [part.strip() for part in parts if part.strip()]
    
    # –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    return [query]

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle incoming messages with improved flexibility and understanding."""
    query = update.message.text
    logger.info(f"Received message: {query}")
    
    # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
    query_lower = query.lower().strip()
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    session = get_session()
    try:
        # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
        category, confidence = classify_query(query)
        logger.info(f"Query classified as: {category} with confidence: {confidence}")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if category == "–ø–æ–∏—Å–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞":
            response = search_employees(query)
        elif category == "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏":
            response = search_events(query, session)
        elif category == "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞—á–µ":
            response = search_tasks(session, query)
        elif category == "—Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏":
            response = search_activities(session, query)
        elif category == "–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è":
            response = search_general_info(session, query)
        else:
            # –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∏–ª–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –Ω–∏–∑–∫–∞—è
            response = (
                "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å. "
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:\n"
                "‚Ä¢ –ö—Ç–æ –∑–Ω–∞–µ—Ç Python?\n"
                "‚Ä¢ –ö–∞–∫–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?\n"
                "‚Ä¢ –ü–æ–∫–∞–∂–∏ –º–æ–∏ –∑–∞–¥–∞—á–∏\n"
                "‚Ä¢ –ö–∞–∫–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è?"
            )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
        await update.message.reply_text(response, parse_mode='Markdown')
        
    except Exception as e:
        logger.error(f"Error in handle_message: {e}")
        await update.message.reply_text(
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. "
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
    finally:
        session.close()

def format_event_results(events, is_upcoming=False):
    """Format event results in a user-friendly way."""
    if not events:
        return "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã."
    
    response = "üìÖ *–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:*\n\n" if not is_upcoming else "–ù–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –í–æ—Ç –±–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:\n\n"
    
    for event in events:
        response += (
            f"*{event.title}*\n"
            f"üìÖ –î–∞—Ç–∞: {event.start_date}"
            f"{f' - {event.end_date}' if event.end_date else ''}\n"
            f"üìç –ú–µ—Å—Ç–æ: {event.location}\n"
            f"üë• –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä: {event.organizer}\n"
            f"üìù {event.description}\n"
            f"üîπ –¢–∏–ø: {event.type.value}\n\n"
        )
    
    return response

async def create_activity(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle activity creation."""
    keyboard = [
        [InlineKeyboardButton("üéÆ –ò–≥—Ä–∞", callback_data="activity_game"),
         InlineKeyboardButton("üçΩ –û–±–µ–¥", callback_data="activity_lunch")],
        [InlineKeyboardButton("üèÉ –°–ø–æ—Ä—Ç", callback_data="activity_sport"),
         InlineKeyboardButton("üéØ –¢–∏–º–±–∏–ª–¥–∏–Ω–≥", callback_data="activity_teambuilding")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="activity_cancel")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üéÆ *–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )
    return CHOOSING

async def join_activity(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle joining an activity."""
    query = update.callback_query
    await query.answer()
    
    activity_id = int(query.data.split('_')[1])
    session = get_session()
    try:
        activity = session.query(Activity).get(activity_id)
        if not activity:
            await query.edit_message_text("‚ùå –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return
        
        if len(activity.participants) >= activity.max_participants:
            await query.edit_message_text("‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—Å–µ –º–µ—Å—Ç–∞ –∑–∞–Ω—è—Ç—ã.")
            return
        
        # Add participant logic here
        await query.edit_message_text(
            f"‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ '{activity.name}'!\n"
            f"–î–∞—Ç–∞: {activity.date}\n"
            f"–í—Ä–µ–º—è: {activity.time}\n"
            f"–ú–µ—Å—Ç–æ: {activity.location}"
        )
    finally:
        session.close()

def init_db():
    """Initialize database with test data."""
    try:
        logger.info("Starting database initialization...")
        
        # Create tables
        logger.info("Dropping existing tables...")
        Base.metadata.drop_all(engine)  # Drop existing tables
        
        logger.info("Creating fresh tables...")
        Base.metadata.create_all(engine)  # Create fresh tables
        
        # Create new session
        logger.info("Creating new session...")
        session = get_session()
        
        try:
            # Add test employees
            logger.info("Adding test employees...")
            employees = [
                Employee(
                    name="–ò–≤–∞–Ω",
                    surname="–ü–µ—Ç—Ä–æ–≤",
                    department="IT",
                    position="Python Developer",
                    skills="Python, Django, Flask, SQL",
                    interests="–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, AI, –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ"
                ),
                Employee(
                    name="–ú–∞—Ä–∏—è",
                    surname="–ò–≤–∞–Ω–æ–≤–∞",
                    department="IT",
                    position="Senior Python Developer",
                    skills="Python, FastAPI, PostgreSQL, Docker",
                    interests="Backend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã"
                ),
                Employee(
                    name="–ê–ª–µ–∫—Å–µ–π",
                    surname="–°–º–∏—Ä–Ω–æ–≤",
                    department="Data Science",
                    position="Data Scientist",
                    skills="Python, Pandas, NumPy, Scikit-learn",
                    interests="–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö, –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ"
                ),
                Employee(
                    name="–ï–ª–µ–Ω–∞",
                    surname="–ö–æ–∑–ª–æ–≤–∞",
                    department="IT",
                    position="Python QA Engineer",
                    skills="Python, Pytest, Selenium, API Testing",
                    interests="–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞"
                )
            ]
            
            # Add employees one by one with logging
            for emp in employees:
                session.add(emp)
                logger.info(f"Added employee: {emp.name} {emp.surname}")
            
            # Commit employees first
            session.commit()
            logger.info("Committed employees to database")
            
            # Add test events
            logger.info("Adding test events...")
            today = datetime.now().date()
            events = [
                Event(
                    title="–¢—Ä–µ–Ω–∏–Ω–≥ –ø–æ Python",
                    description="–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Python –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤",
                    date=today + timedelta(days=1),
                    time=datetime.strptime("14:00", "%H:%M").time(),
                    location="–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü-–∑–∞–ª 2",
                    type=EventType.TRAINING
                ),
                Event(
                    title="–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ –∫–æ–º–∞–Ω–¥—ã",
                    description="–û–±—Å—É–∂–¥–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á –∏ –ø–ª–∞–Ω–æ–≤",
                    date=today + timedelta(days=1),
                    time=datetime.strptime("10:00", "%H:%M").time(),
                    location="–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü-–∑–∞–ª 1",
                    type=EventType.MEETING
                ),
                Event(
                    title="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –æ–±–µ–¥",
                    description="–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±–µ–¥ –¥–ª—è –≤—Å–µ–π –∫–æ–º–∞–Ω–¥—ã",
                    date=today + timedelta(days=1),
                    time=datetime.strptime("13:00", "%H:%M").time(),
                    location="–°—Ç–æ–ª–æ–≤–∞—è",
                    type=EventType.HOLIDAY
                )
            ]
            
            # Add events one by one with logging
            for event in events:
                session.add(event)
                logger.info(f"Added event: {event.title} on {event.date}")
            
            # Commit events
            session.commit()
            logger.info("Committed events to database")
            
            logger.info("Database initialization completed successfully")
            
        except Exception as e:
            logger.error(f"Error during database initialization: {e}")
            session.rollback()
            raise
            
    except Exception as e:
        logger.error(f"Error initializing database: {e}")
        raise
    finally:
        if 'session' in locals():
            session.close()
            logger.info("Database session closed")

def main():
    """Start the bot."""
    try:
        # Initialize database
        logger.info("Starting bot initialization...")
        init_db()
        
        # Verify database initialization
        session = get_session()
        try:
            # Check total employees
            employee_count = session.query(Employee).count()
            logger.info(f"Database verification: Found {employee_count} employees")
            
            if employee_count == 0:
                logger.error("Database initialization failed: no employees found")
                raise Exception("Database initialization failed: no employees found")
            
            # List all employees for verification
            all_employees = session.query(Employee).all()
            logger.info("All employees in database:")
            for emp in all_employees:
                logger.info(f"Employee: {emp.name} {emp.surname}, Position: {emp.position}, Skills: {emp.skills}")
            
            # Verify Python employees specifically
            python_employees = session.query(Employee).filter(
                or_(
                    Employee.skills.ilike("%Python%"),
                    Employee.position.ilike("%Python%")
                )
            ).all()
            
            logger.info(f"Found {len(python_employees)} employees with Python skills")
            for emp in python_employees:
                logger.info(f"Python employee: {emp.name} {emp.surname}, Position: {emp.position}, Skills: {emp.skills}")
            
            if not python_employees:
                logger.error("Database initialization failed: no Python employees found")
                raise Exception("Database initialization failed: no Python employees found")
            
            # Check events
            event_count = session.query(Event).count()
            logger.info(f"Database verification: Found {event_count} events")
            
        finally:
            session.close()
        
        # Create the Application
        application = Application.builder().token('8181926764:AAE0RsZomH3bdhLnGqatSi5W7HH3fwjiEQQ').build()

        # Add handlers
        application.add_handler(CommandHandler("start", start))
        application.add_handler(CommandHandler("help", help_command))
        
        # Add message handler for text messages
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        
        # Add conversation handler for activity creation
        conv_handler = ConversationHandler(
            entry_points=[CommandHandler("create_activity", create_activity)],
            states={
                CHOOSING: [
                    CallbackQueryHandler(join_activity, pattern="^activity_")
                ],
                TYPING_REPLY: [
                    MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)
                ]
            },
            fallbacks=[CommandHandler("cancel", lambda u, c: ConversationHandler.END)]
        )
        application.add_handler(conv_handler)

        # Start the Bot
        logger.info("Starting bot polling...")
        application.run_polling()
        
    except Exception as e:
        logger.error(f"Error in main: {e}")
        raise

if __name__ == '__main__':
    main() 